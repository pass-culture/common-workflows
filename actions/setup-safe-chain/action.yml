name: "Setup safe-chain"
description: "This action installs safe-chain in a specific version."
inputs:
  version:
    type: string
    required: true
  checksum:
    type: string
    required: true
    description: "SHA256 hash of the safe-chain binary file."

runs:
  using: "composite"
  steps:
    - name: setup
      uses: actions/checkout@v4

    - name: "Render manifests"
      shell: bash
      run: |
        set -e
        if ! [ -x "$(command -v curl)" ]; then
          sudo apt update && sudo apt install -qy curl
        fi
        INSTALL_DIR="${HOME}/.safe-chain/bin"
        REPO_URL="https://github.com/AikidoSec/safe-chain"
        # Detect OS
        detect_os() {
            case "$(uname -s)" in
                Linux*)     echo "linux" ;;
                Darwin*)    echo "macos" ;;
                *)          echo "Unsupported operating system: $(uname -s)" ;;
            esac
        }

        # Detect architecture
        detect_arch() {
            case "$(uname -m)" in
                x86_64|amd64)   echo "x64" ;;
                aarch64|arm64)  echo "arm64" ;;
                *)              echo "Unsupported architecture: $(uname -m)" ;;
            esac
        }

        # Download file
        download() {
            url="$1"
            dest="$2"

            curl -fsSL "$url" -o "$dest" || echo "Failed to download from $url"
        }

        # Check file integrity
        check_file() {
            file="$1"

            hash=$(sha256sum $file | awk '{ print $1 }')

            if [ "$hash" != "$CHECKSUM" ]; then
                echo "Invalid checksum. Got $hash ; expected $CHECKSUM Exiting."
                rm $file
                exit 1
            fi
            echo "File integrity validated"
        }

        # Main installation
        main() {

            # Build installation message
            INSTALL_MSG="Installing safe-chain ${VERSION}"

            echo "$INSTALL_MSG"

            # Detect platform
            OS=$(detect_os)
            ARCH=$(detect_arch)
            BINARY_NAME="safe-chain-${OS}-${ARCH}"

            echo "Detected platform: ${OS}-${ARCH}"

            # Create installation directory
            if [ ! -d "$INSTALL_DIR" ]; then
                echo "Creating installation directory: $INSTALL_DIR"
                mkdir -p "$INSTALL_DIR" || echo "Failed to create directory $INSTALL_DIR"
            fi

            # Download binary
            DOWNLOAD_URL="${REPO_URL}/releases/download/${VERSION}/${BINARY_NAME}"
            TEMP_FILE="${INSTALL_DIR}/${BINARY_NAME}"

            echo "Downloading from: $DOWNLOAD_URL"
            download "$DOWNLOAD_URL" "$TEMP_FILE"
            check_file "$TEMP_FILE"

            # Rename and make executable
            FINAL_FILE="${INSTALL_DIR}/safe-chain"
            mv "$TEMP_FILE" "$FINAL_FILE" || echo "Failed to move binary to $FINAL_FILE"
            chmod +x "$FINAL_FILE" || echo "Failed to make binary executable"

            echo "Binary installed to: $FINAL_FILE"

            # Build setup command based on arguments
            SETUP_CMD="setup-ci"
            SETUP_ARGS="--include-python"

            # Execute safe-chain setup
            echo "Running safe-chain $SETUP_CMD $SETUP_ARGS..."
            if ! "$FINAL_FILE" $SETUP_CMD $SETUP_ARGS; then
                echo "safe-chain was installed but setup encountered issues."
            fi
        }
        main "$@"
      env:
        VERSION: ${{ inputs.version }}
        CHECKSUM: ${{ inputs.checksum }}
